# Define UTF-8 encoding for all essential file types
AddDefaultCharset utf-8
<IfModule mod_mime.c>
    AddCharset utf-8 .css .js .json .xml .svg
</IfModule>

# Add 'Vary: Accept-Encoding' header
<IfModule mod_headers.c>
  <FilesMatch ".(js|css|xml|gz|html)$">
    Header append Vary: Accept-Encoding
  </FilesMatch>
</IfModule>

# Disable fallback directory indexes
Options -Indexes

# Provide email address for internal server errors
SetEnv SERVER_ADMIN caleb@calebevans.me

# Error code pages
ErrorDocument 403 /403/
ErrorDocument 404 /404/

# Enable gzip compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/xml text/css text/javascript application/javascript application/x-javascript application/json application/xml
</IfModule>

### Headers

<IfModule mod_headers.c>

  # Cache HTML, scripts, stylesheets, and images
  <FilesMatch '\.(html|css|js|png|jpg|gif|svg)$'>
    # Set restrictive Content Security Policy (CSP)
    # See https://content-security-policy.com/ for a complete reference
    Header set Content-Security-Policy "default-src 'none'; style-src 'self' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://www.gravatar.com https://www.google-analytics.com; script-src 'self' https://cdnjs.cloudflare.com https://www.google-analytics.com;"
    # Set cache to expire after one day
    Header set Cache-Control 'max-age=3600'
  </FilesMatch>

</IfModule>

<IfModule mod_rewrite.c>

  # Enable URL rewriting
  RewriteEngine On
  RewriteBase /

  # Redirect www to non-www
  RewriteCond %{HTTP_HOST} ^www\.calebevans\.me [NC]
  RewriteRule ^(.*)$ http://calebevans.me/$1 [R=301,L]

  # Redirect /projects/* to projects.calebevans.me/*
  RewriteRule ^projects/(.+)$ http://projects.calebevans.me/$1 [R=301,NC,L]

</IfModule>
