# Define UTF-8 encoding for all essential file types
AddDefaultCharset utf-8
<IfModule mod_mime.c>
  AddCharset utf-8 .css .js .json .xml .svg
</IfModule>

# Disable fallback directory indexes
Options -Indexes

# Provide email address for internal server errors
SetEnv SERVER_ADMIN caleb@calebevans.me

# Error code pages
ErrorDocument 403 /403/
ErrorDocument 404 /404/

# Enable gzip compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css application/javascript
</IfModule>

### Headers

<IfModule mod_headers.c>

  # Bolster security on served pages
  <FilesMatch "\.html$">
    # Set restrictive Content Security Policy (CSP)
    # See https://content-security-policy.com/ for a complete reference
    Header always set Content-Security-Policy "default-src 'none'; style-src 'self' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://www.gravatar.com https://www.google-analytics.com; script-src 'self' https://cdnjs.cloudflare.com https://www.google-analytics.com"
    # Restrict site from being used in any kind of frame
    Header always set X-Frame-Options DENY
    # Require every resource to have a valid MIME type
    Header always set X-Content-Type-Options nosniff
    # Tell browser to always serve HTTPS pages on this site and its subdomains
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
  </FilesMatch>

  # Cache HTML, scripts, stylesheets, and images
  <FilesMatch "\.(html|css|js|png|jpg|gif|svg)$">
    # Set cache to expire after one day
    Header set Cache-Control "max-age=3600"
  </FilesMatch>

  # Instruct caches and proxies to store the compressed and uncompressed
  # versions of resources
  <FilesMatch "\.(html|css|js|gz)$">
    Header append Vary: Accept-Encoding
  </FilesMatch>

</IfModule>

<IfModule mod_rewrite.c>

  # Enable URL rewriting
  RewriteEngine On
  RewriteBase /

  # Redirect www to non-www
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^(.*)$ https://%1/$1 [L,R=301]

  # Redirect HTTP to HTTPS
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [L,R=301]

  # Redirect /projects/* to projects.calebevans.me/*
  RewriteRule ^projects/(.+)$ https://projects.calebevans.me/$1 [L,NC,R=301]

  # Redirect /* pages to /*/
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_URI} !(.*)/$
  RewriteRule ^(.*?)$ $1/ [L,NC,R=301]

</IfModule>
